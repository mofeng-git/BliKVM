name: Build and Push Docker Image

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Docker tag: dev or latest'
        required: true
        type: choice
        options:
          - dev
          - latest
        default: dev
      platforms:
        description: 'Target platforms'
        required: true
        type: choice
        options:
          - linux/arm64
          - linux/arm64,linux/arm/v7
        default: linux/arm64
      enable_aliyun:
        description: 'Push to Aliyun Registry (registry.cn-hangzhou.aliyuncs.com)'
        required: true
        type: boolean
        default: true

env:
  DOCKERHUB_IMAGE: silentwind0/blikvm
  ALIYUN_IMAGE: registry.cn-hangzhou.aliyuncs.com/silentwind/blikvm

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to Aliyun Registry
        if: github.event.inputs.enable_aliyun == 'true'
        uses: docker/login-action@v3
        with:
          registry: registry.cn-hangzhou.aliyuncs.com
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: Compose image list
        id: imagelist
        run: |
          images="${{ env.DOCKERHUB_IMAGE }}"
          if [ "${{ github.event.inputs.enable_aliyun }}" = "true" ]; then
            images="$images\n${{ env.ALIYUN_IMAGE }}"
          fi
          printf 'images<<EOF\n%s\nEOF\n' "$images" >> "$GITHUB_OUTPUT"

      - name: Select tag
        id: tag
        run: |
          echo "value=${{ github.event.inputs.version_type }}" >> "$GITHUB_OUTPUT"

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.imagelist.outputs.images }}
          tags: |
            type=raw,value=${{ steps.tag.outputs.value }}
            type=raw,value=${{ steps.tag.outputs.value }}-{{date 'YYYYMMDD-HHmmss'}}
            type=sha,prefix={{branch}}-
          labels: |
            org.opencontainers.image.title=BliKVM
            org.opencontainers.image.description=BliKVM Docker image
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.version=${{ steps.tag.outputs.value }}

      - name: Build and push image
        uses: docker/build-push-action@v5
        env:
          BUILDKIT_PROGRESS: plain
        with:
          context: .
          file: build/Dockerfile
          platforms: ${{ github.event.inputs.platforms }}
          pull: true
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=blikvm
          cache-to: type=gha,mode=max,scope=blikvm
          provenance: false
          sbom: false

      - name: Build summary
        run: |
          echo "## Build Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "- Version Tag: ${{ steps.tag.outputs.value }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Platforms: ${{ github.event.inputs.platforms }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Aliyun Enabled: ${{ github.event.inputs.enable_aliyun }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Tags:" >> "$GITHUB_STEP_SUMMARY"
          echo "${{ steps.meta.outputs.tags }}" | sed 's/^/  - /' >> "$GITHUB_STEP_SUMMARY"

